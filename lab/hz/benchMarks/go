#!/usr/bin/env bash

set -e
cleanup() {
    exitCode=$?
    hz download
    chart-ComparisonMetrics output NEW OLD || true
    chart-allComparisonHdr  output NEW OLD || true

    hz-view output Client > client.html
    hz-view output Member > member.html

    driver-wideMetrics output NEW OLD || true

    hz wipe

    exit ${exitCode}
}
trap "cleanup" INT TERM EXIT

hzVersion=${1:-$(hazelcastVersion)}

split -l 4 a.box

#hz broker -ip 10.212.1.107
hzOps="-Dhazelcast.enterprise.license.key=${HAZELCAST_EE_KEY} -Dhazelcast.backpressure.enabled=true"
hz memberOps "-XX:+PrintFlagsFinal -Xms4G -Xmx4G ${hzOps}"
hz clientOps "-XX:+PrintFlagsFinal -Xms500M -Xmx500M ${hzOps}"
hz cluster -size M4C4 -id NEW -v 3.7 -type HZ -boxes xaa -user danny
hz cluster -size M4C4 -id OLD -v 3.6          -type HZ -boxes xab -user danny

hz driver Client,Member
hz type Metrics
hz interval 0
hz threads 64
hz warmup 60
hz bench 120

hz run marks/map/put/* marks/map/set/* marks/map/get/* marks/map/contains/* marks/sql/* marks/cache/* marks/atomic/* marks/latch/* marks/lock/*

#hz run marks/map/put/* marks/map/set/* marks/map/get/* marks/map/contains/* marks/sql/*