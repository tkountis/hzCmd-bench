#!/usr/bin/env bash

set -e
cleanup() {
    exitCode=$?
    echo "exitCode=${exitCode}"
    if [[ ${exitCode} != 0 ]]; then
       linkPath=$(pwd)
       linkPath=${linkPath#'/disk1/'}
       slack-post simulator-fail FAIL \<http://54.87.52.100/~${linkPath}\>
    fi
    hz wipe

    aws-terminate a.box
    if [ -n "${compare}" ] ; then
        aws-terminate b.box
    fi

    hz-killSubJava

    exit $exitCode
}
trap "cleanup" INT TERM EXIT

testDir=${1}
boxCount=${2}
type=${3:-c4.xlarge}
compare=${4}

hz-bench-update

subDir="$(getHazelcastVersion)/$(date '+%Y_%m_%d-%H_%M_%S')"
mkdir -p ${subDir}

cp a.box ${subDir} 2>/dev/null || true
cp b.box ${subDir} 2>/dev/null || true
cd ${subDir}
pwd
cp -r ${HZ_CMD_BENCH_SRC}/lab/${testDir}/* .

aws-create ${boxCount} ${type} a.box
if [ -n "${compare}" ] ; then
  hz-awsBox ${boxCount} ${type} b.box
fi

./go


